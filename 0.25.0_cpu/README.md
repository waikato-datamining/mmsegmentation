# MMDetection

Allows processing of images with [MMSegmentation](https://github.com/open-mmlab/mmsegmentation).

Uses PyTorch 1.9.0 and [CPU support](https://mmsegmentation.readthedocs.io/en/latest/get_started.html#install-on-cpu-only-platforms).

## Version

MMDetection github repo tag/hash:

```
v0.25.0
46326f63ce411c794d237e986dd3924590d0e75e
```

and timestamp:

```
June 3rd, 2022
```

## Docker

### Quick start

* Log into registry using *public* credentials:

  ```bash
  docker login -u public -p public public.aml-repo.cms.waikato.ac.nz:443 
  ```

* Pull and run image (adjust volume mappings `-v`):

  ```bash
  docker run --shm-size 8G \
    -v /local/dir:/container/dir \
    -it public.aml-repo.cms.waikato.ac.nz:443/open-mmlab/mmsegmentation:0.25.0_cpu
  ```

* If need be, remove all containers and images from your system:

  ```bash
  docker stop $(docker ps -a -q) && docker rm $(docker ps -a -q) && docker system prune -a
  ```

### Docker hub

The image is also available from [Docker hub](https://hub.docker.com/u/waikatodatamining):

```
waikatodatamining/mmsegmentation:0.25.0_cpu
```

### Build local image

* Build the image from Docker file (from within /path_to/mmsegmentation/0.25.0_cpu)

  ```bash
  docker build -t mmseg .
  ```
  
* Run the container

  ```bash
  docker run --shm-size 8G -v /local/dir:/container/dir -it mmseg
  ```
  `/local/dir:/container/dir` maps a local disk directory into a directory inside the container

### Scripts

The following scripts are available:

* `mmseg_predict_poll` - for applying a model to images (uses file-polling)
* `mmseg_predict_redis` - for applying a model to images (via [Redis](https://redis.io/) backend)

### Usage

* TODO

## Pre-built images

* Build

  ```bash
  docker build -t open-mmlab/mmsegmentation:0.25.0_cpu .
  ```
  
* Tag

  ```bash
  docker tag \
    mmsegmentation:0.25.0_cpu \
    public-push.aml-repo.cms.waikato.ac.nz:443/open-mmlab/mmsegmentation:0.25.0_cpu
  ```
  
* Push

  ```bash
  docker push public-push.aml-repo.cms.waikato.ac.nz:443/open-mmlab/mmsegmentation:0.25.0_cpu
  ```
  If error "no basic auth credentials" occurs, then run (enter username/password when prompted):
  
  ```bash
  docker login public-push.aml-repo.cms.waikato.ac.nz:443
  ```
  
* Pull

  If image is available in aml-repo and you just want to use it, you can pull using following command and then [run](#run).

  ```bash
  docker pull public.aml-repo.cms.waikato.ac.nz:443/open-mmlab/mmsegmentation:0.25.0_cpu
  ```
  If error "no basic auth credentials" occurs, then run (enter username/password when prompted):
  
  ```bash
  docker login public.aml-repo.cms.waikato.ac.nz:443
  ```
  Then tag by running:
  
  ```bash
  docker tag \
    public.aml-repo.cms.waikato.ac.nz:443/open-mmlab/mmsegmentation:0.25.0_cpu \
    open-mmlab/mmsegmentation:0.25.0_cpu
  ```
  
* <a name="run">Run</a>

  ```bash
  docker run --shm-size 8G \
    -v /local/dir:/container/dir -it open-mmlab/mmsegmentation:0.25.0_cpu
  ```
  `/local/dir:/container/dir` maps a local disk directory into a directory inside the container



## Permissions

When running the docker container as regular use, you will want to set the correct
user and group on the files generated by the container (aka the user:group launching
the container):

```bash
docker run -u $(id -u):$(id -g) -e USER=$USER ...
```

## Caching models

PyTorch downloads base models, if necessary. However, by using Docker, this means that 
models will get downloaded with each Docker image, using up unnecessary bandwidth and
slowing down the startup. To avoid this, you can map a directory on the host machine
to cache the base models for all processes (usually, there would be only one concurrent
model being trained):  

```
-v /somewhere/local/cache:/.cache
```

Or specifically for PyTorch:

```
-v /somewhere/local/cache/torch:/.cache/torch
```

**NB:** When running the container as root rather than a specific user, the internal directory will have to be
prefixed with `/root`. 


## Testing Redis

You can use [simple-redis-helper](https://pypi.org/project/simple-redis-helper/) to broadcast images 
and listen for image segmentation results when testing.
